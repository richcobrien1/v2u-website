name: Token Health Check

on:
  schedule:
    # Run once daily at 08:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  check-token-health:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Token Expiration Status
        id: check
        run: |
          echo "ðŸ” Checking token health..."
          
          RESPONSE=$(curl -s "https://www.v2u.us/api/automation/rotate-tokens")
          
          echo "Token Status:"
          echo "$RESPONSE" | jq '.'
          
          # Check if the request was successful
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
          
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ API request failed"
            echo "$RESPONSE" | jq '.error // "Unknown error"'
            exit 1
          fi
          
          # Check if any tokens need rotation
          NEEDS_ROTATION=$(echo "$RESPONSE" | jq -r '.tokenStatus | to_entries[] | select(.value.needsRotation == true) | .key' | tr '\n' ' ')
          
          if [ -n "$NEEDS_ROTATION" ]; then
            echo "âš ï¸ The following platforms need token rotation:"
            echo "$NEEDS_ROTATION"
            echo "needs_rotation=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… All tokens are healthy"
            echo "needs_rotation=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Trigger Rotation if Needed
        if: steps.check.outputs.needs_rotation == 'true'
        run: |
          echo "ðŸ”„ Triggering emergency token rotation..."
          
          curl -X POST "https://www.v2u.us/api/automation/rotate-tokens"
          
          echo "âœ… Emergency rotation triggered"
          
      - name: Alert on Critical Status
        if: steps.check.outputs.needs_rotation == 'true'
        run: |
          echo "ðŸš¨ CRITICAL: Tokens were close to expiration and have been auto-rotated"
          echo "Check status at: https://www.v2u.us/admin/social-posting"
